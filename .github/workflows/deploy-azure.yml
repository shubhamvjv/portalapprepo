name: Deploy to Azure Web App

on:
  push:
    branches: [ "main" ]
    paths:
      - '**/*.ts'
      - '**/*.tsx'
      - 'package.json'
      - 'yarn.lock'
      - 'next.config.js'
      - 'public/**'
      - 'src/**'

  workflow_dispatch:
    inputs: 
      webapp_name:
        description: 'The dynamically provisioned Azure Web App name.'
        required: false
        type: string

# GLOBAL ENV: Makes these variables available to all jobs
env:
  # 1. LOGIC: Use Input (Manual) OR Secret (Push)
  AZURE_WEBAPP_NAME: ${{ github.event.inputs.webapp_name || secrets.AZURE_WEBAPP_NAME }}
  AZURE_RG: ${{ secrets.AZURE_RESOURCE_GROUP }}
  AZURE_REGION: ${{ secrets.AZURE_REGION }}
  # 2. AUTHENTICATION
  AZ_CLIENT_ID: ${{ secrets.AZ_CLIENT_ID }}
  AZ_CLIENT_SECRET: ${{ secrets.AZ_CLIENT_SECRET }}
  AZ_SUBSCRIPTION_ID: ${{ secrets.AZ_SUBSCRIPTION_ID }}
  AZ_TENANT_ID: ${{ secrets.AZ_TENANT_ID }}

jobs:

  build:
    runs-on: ubuntu-latest
    outputs:
      artifact-name: next-build

    steps:

      - name: üïµÔ∏è Debug Secret Presence
        run: |
          if [ -z "${{ secrets.AZ_CLIENT_ID }}" ]; then
            echo "‚ùå ERROR: AZ_CLIENT_ID secret is MISSING or EMPTY."
            exit 1
          else
            echo "‚úÖ AZ_CLIENT_ID is present."
          fi
          
          if [ -z "${{ secrets.AZURE_WEBAPP_NAME }}" ]; then
            echo "‚ö†Ô∏è WARNING: AZURE_WEBAPP_NAME secret is missing. (This is OK if you provided a Manual Input)"
          else
            echo "‚úÖ AZURE_WEBAPP_NAME secret is present."
          fi
      # üëÜüëÜüëÜ END INSERT üëÜüëÜüëÜ
      
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "yarn"

      - name: Enable Corepack + Yarn Berry
        run: |
          corepack enable
          corepack prepare yarn@stable --activate

      - name: Install Dependencies
        run: |
          yarn config set enableImmutableInstalls false
          yarn install

      - name: Build Next.js
        env:
          NODE_OPTIONS: --no-node-snapshot
        run: yarn build

      - name: Archive for Deploy
        run: |
          # 1. Copy public assets
          cp -r public ./.next/standalone/public
          
          # 2. Create the static folder structure
          mkdir -p ./.next/standalone/.next/static
          
          # 3. Copy the actual static files (CSS/JS chunks)
          cp -r .next/static/* ./.next/standalone/.next/static/
          
          # 4. Zip the standalone folder
          tar -czf app.tar.gz -C ./.next/standalone .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: next-build
          path: app.tar.gz


  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: next-build

      - name: Unpack Artifact
        run: tar -xzf app.tar.gz

      # -------------------------------
      # üîê AZURE LOGIN
      # -------------------------------
      - name: Azure CLI Login
        run: |
          az login --service-principal \
            --username "$AZ_CLIENT_ID" \
            --password "$AZ_CLIENT_SECRET" \
            --tenant "$AZ_TENANT_ID"
          az account set --subscription "$AZ_SUBSCRIPTION_ID"

      # -------------------------------
      # üü¶ TERRAFORM SECTION
      # -------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # FIXED: Values are now injected from the env variables
      - name: Create terraform.tfvars
        run: |
          mkdir -p terraform
          cat <<EOF > terraform/terraform.tfvars
          subscription_id     = "${{ env.AZ_SUBSCRIPTION_ID }}"
          tenant_id           = "${{ env.AZ_TENANT_ID }}"
          client_id           = "${{ env.AZ_CLIENT_ID }}"
          client_secret       = "${{ env.AZ_CLIENT_SECRET }}"
          resource_group_name = "${{ env.AZURE_RG }}"
          location            = "${{ env.AZURE_REGION }}"
          app_service_name    = "${{ env.AZURE_WEBAPP_NAME }}"
          EOF

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve

      # -------------------------------
      # üö´ DELETED: Manual 'az create' commands
      # Terraform (above) already created the plan and webapp.
      # Running 'az create' again here causes errors.
      # -------------------------------

      # -------------------------------
      # üöÄ DEPLOY NEXT.JS ARTIFACT
      # -------------------------------
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          # FIXED: Now uses the variable
          app-name: ${{ env.AZURE_WEBAPP_NAME }} 
          package: .
          slot-name: production

      - name: Restart Web App
        run: az webapp restart --name "$AZURE_WEBAPP_NAME" --resource-group "$AZURE_RG"


